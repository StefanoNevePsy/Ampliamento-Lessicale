<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS & WebApp Meta Tags -->
    <title>Stimolatore Lessicale V14</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Stimolatore">
    <meta name="theme-color" content="#1e1e2f">

    <!-- ICONA GENERATA (SVG Base64) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2MzY2ZjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM4YjVjZjYiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0idXJsKCNnKSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiLz48cGF0aCBkPSJNMzYwIDI1NmMwLTU3LjQtNDYuNi0xMDQtMTA0LTEwNHMtMTA0IDQ2LjYtMTA0IDEwNCA0Ni42IDEwNCAxMDQgMTA0YzEyLjggMCAyNS0yLjMgMzYuNC02LjUgMTAuMyA5LjggMjQuNiAxOC41IDQxLjYgMjIuNSAzLjEgMC43IDYuMi0xLjYgNi4yLTQuOCAwLTIuNy0xLjUtNS4yLTMuOS02LjYtMTEuNC02LjctMTguOC0xNi45LTE4LjgtMTYuOSAzMC42LTIzLjIgNTguOS02MS44IDQyLjUtOTEuN3oiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2MzY2ZjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM4YjVjZjYiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0idXJsKCNnKSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiLz48cGF0aCBkPSJNMzYwIDI1NmMwLTU3LjQtNDYuNi0xMDQtMTA0LTEwNHMtMTA0IDQ2LjYtMTA0IDEwNCA0Ni42IDEwNCAxMDQgMTA0YzEyLjggMCAyNS0yLjMgMzYuNC02LjUgMTAuMyA5LjggMjQuNiAxOC41IDQxLjYgMjIuNSAzLjEgMC43IDYuMi0xLjYgNi4yLTQuOCAwLTIuNy0xLjUtNS4yLTMuOS02LjYtMTEuNC02LjctMTguOC0xNi45LTE4LjgtMTYuOSAzMC42LTIzLjIgNTguOS02MS44IDQyLjUtOTEuN3oiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlN0aW1vbGF0b3JlIiwKICAic2hvcnRfbmFtZSI6ICJTdGltb2xhdG9yZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWUxZTJmIiwKICAidGhlbWVfY29xvciI6ICIjMWUxZTJmIgp9">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e1e2f 0%, #2d2b55 100%);
            --glass-bg: rgba(30, 30, 50, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --radius: 16px;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --theme-color: #6366f1;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Noto Sans', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0; 
            padding: env(safe-area-inset-top) 10px 10px 10px; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        .app-shell {
            width: 100%; max-width: 1200px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 20px;
            position: relative; min-height: 85vh;
        }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
        .badge-pro { background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; vertical-align: middle; }
        
        .btn-icon {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--text-primary); width: 40px; height: 40px; border-radius: 10px;
            cursor: pointer; display: grid; place-items: center; transition: 0.2s; font-size: 1.1rem; position: relative;
        }
        .btn-icon:hover { background: var(--accent-color); border-color: var(--accent-color); }
        .badge-count { 
            position:absolute; top:-5px; right:-5px; background:var(--danger-color); 
            color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; 
        }

        /* STORAGE BAR */
        .storage-bar-container {
            font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px;
            display: none; /* Hidden on small screens */
        }
        @media (min-width: 600px) { .storage-bar-container { display: flex; } }

        .storage-progress { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .storage-fill { height: 100%; background: var(--success-color); width: 0%; transition: width 0.5s; }

        /* CONTROLS */
        .controls-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .control-group { flex: 1; min-width: 200px; }
        .control-group label {
            display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);
            margin-bottom: 6px; text-transform: uppercase;
        }
        select, input[type="text"], input[type="password"] {
            width: 100%; padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 10px; color: white; font-size: 0.95rem;
            appearance: none; cursor: pointer;
        }
        select:focus, input:focus { border-color: var(--accent-color); }

        /* ACTIONS */
        .actions-row { display: flex; gap: 10px; justify-content: center; padding: 10px 0; }
        .btn {
            padding: 12px 24px; border-radius: 10px; border: none; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1rem;
            transition: transform 0.1s; color: white;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--accent-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-ghost { background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* STAGE */
        #game-stage {
            flex: 1; min-height: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius);
            position: relative; overflow: hidden;
            border: 2px dashed var(--glass-border);
            display: flex; flex-direction: column;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Loaders & Game UI Styles */
        .memory-grid { display: grid; gap: 10px; padding: 20px; grid-template-columns: repeat(4, 1fr); max-width: 800px; margin: 0 auto; }
        .memory-card { aspect-ratio: 1; perspective: 1000px; cursor: pointer; position: relative; }
        .memory-inner { width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .memory-card.flipped .memory-inner { transform: rotateY(180deg); }
        .memory-card.matched { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        .memory-front, .memory-back { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .memory-front { background: var(--theme-color); color: white; font-size: 2rem; transform: rotateY(0deg); z-index: 2; }
        .memory-back { background: white; transform: rotateY(180deg); padding: 5px; z-index: 1; }
        .memory-back img { width: 100%; height: 100%; object-fit: contain; }

        .tombola-layout { display: flex; flex: 1; height: 100%; flex-direction: column; }
        @media (min-width: 768px) { .tombola-layout { flex-direction: row; } }
        .tombola-deck { flex: 0 0 250px; background: rgba(0,0,0,0.3); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tombola-board { flex: 1; padding: 20px; background-color: rgba(0,0,0,0.1); overflow-y: auto; }
        .card-grid { cursor: pointer; transition: 0.2s; background: white; border-radius: 12px; padding: 5px; position:relative; }
        .card-grid img { width: 100%; height: auto; border-radius: 6px; }
        .card-grid.matched { opacity: 0.4; filter: grayscale(100%); pointer-events: none; }
        .card-grid.matched::after { content: 'âœ”'; position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); font-size: 3rem; color: var(--success-color); }
        
        .tact-stage { display: flex; justify-content: center; align-items: center; flex: 1; padding: 20px; }
        .tact-card-lg { background: white; padding: 20px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; }
        .tact-card-lg img { width: 100%; height: 350px; object-fit: contain; }
        .tact-title { font-size: 2.5rem; color: #333; margin-top: 15px; font-weight: 800; }
        .ran-grid-container { display: grid; gap: 15px; max-width: 800px; margin: 0 auto; }

        /* MODALS & LISTS */
        .modal-fs { position: fixed; inset: 0; background: #1e1e2f; z-index: 1000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-fs.open { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding-top: env(safe-area-inset-top); } 
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; padding-bottom: 80px; }

        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .lib-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; transition: 0.2s; display: flex; flex-direction: column; gap: 10px; }
        .lib-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent-color); }
        .lib-card.clinical { border-left: 4px solid var(--success-color); }

        .editor-item { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid transparent; flex-wrap: wrap; }
        .editor-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #333; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .editor-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .editor-meta { flex: 1; min-width: 200px; }
        .prompt-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 5px; font-size: 0.8rem; margin-top: 5px; color: #ccc; }
        
        .loader-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; color: white; z-index: 5; }
    </style>
</head>
<body>

    <div class="app-shell">
        
        <header>
            <div>
                <h1>Stimolatore Lessicale <span class="badge-pro">V14</span></h1>
                <div class="storage-bar-container">
                    <i class="fa-solid fa-hard-drive"></i>
                    <div class="storage-progress"><div id="storage-fill" class="storage-fill"></div></div>
                    <span id="storage-text">DB</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="btn-icon" onclick="toggleFullScreen()" title="Schermo Intero">
                    <i class="fa-solid fa-expand" id="fs-icon"></i>
                </button>
                <button class="btn-icon" onclick="openLibrary()" title="Libreria Set">
                    <i class="fa-solid fa-book-open"></i>
                    <span id="lib-count" class="badge-count">0</span>
                </button>
                <button class="btn-icon" onclick="openSettings()" title="API Key">
                    <i class="fa-solid fa-key"></i>
                </button>
            </div>
        </header>

        <!-- CONTROLLI -->
        <div class="controls-row">
            <div class="control-group">
                <label>ModalitÃ </label>
                <select id="mode-select" onchange="changeMode()">
                    <option value="tact">TACT (Denominazione)</option>
                    <option value="ran">RAN (Denominazione Rapida)</option>
                    <option value="tombola">Tombola (Matching)</option>
                    <option value="memory">Memory (Coppie)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Generazione / Set</label>
                <select id="category-select">
                    <option value="" disabled selected>-- Seleziona Set --</option>
                    <optgroup label=" âœ¨ AI Custom">
                        <option value="ai_custom">Prompt Personale (Richiede API Key)...</option>
                    </optgroup>
                    <optgroup label="ðŸ¶ Animali">
                        <option value="anim_liv1">Liv 1: Bisillabe Piane</option>
                        <option value="anim_liv2">Liv 2: Trisillabe / Complesse</option>
                        <option value="anim_liv3">Liv 3: Gruppi Consonantici</option>
                    </optgroup>
                    <optgroup label="ðŸŽ Cibi">
                        <option value="food_liv1">Liv 1: Semplici</option>
                        <option value="food_liv2">Liv 2: Medi / Complessi</option>
                    </optgroup>
                    <optgroup label="ðŸ  Casa & Oggetti">
                        <option value="home_liv1">Liv 1: Alta Frequenza</option>
                        <option value="home_liv2">Liv 2: Media Frequenza</option>
                    </optgroup>
                    <optgroup label="ðŸ‘• Abbigliamento">
                        <option value="clothes_liv1">Vestiario Comune</option>
                    </optgroup>
                    <optgroup label="ðŸƒ Azioni (Verbi)">
                        <option value="verbs_liv1">Azioni Quotidiane</option>
                    </optgroup>
                </select>
                <input type="text" id="custom-input" class="hidden" placeholder="Es. Strumenti musicali..." style="margin-top:5px;">
            </div>

            <div class="control-group">
                <label>Stile</label>
                <select id="style-select">
                    <option value="mixed">ðŸ”€ Misto</option>
                    <option value="3d">ðŸ§¸ 3D Clay</option>
                    <option value="vector">ðŸŽ¨ Icone</option>
                    <option value="realistic">ðŸ“· Foto</option>
                </select>
            </div>

            <div class="control-group">
                <label>Grid Size</label>
                <select id="grid-size">
                    <option value="3">9 (3x3)</option>
                    <option value="4" selected>16 (4x4)</option>
                    <option value="5">25 (5x5)</option>
                </select>
            </div>
        </div>

        <div class="actions-row">
            <button class="btn btn-primary" onclick="startSession()">
                <i class="fa-solid fa-play"></i> Genera
            </button>
            <button class="btn btn-ghost" onclick="openLibrary()">
                <i class="fa-solid fa-folder-open"></i> Apri Libreria
            </button>
            <button id="btn-save" class="btn btn-success hidden" onclick="saveSetFromSession()">
                <i class="fa-solid fa-floppy-disk"></i> Salva
            </button>
        </div>

        <!-- STAGE -->
        <div id="game-stage">
            <div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--text-secondary);">
                <i class="fa-solid fa-database" style="font-size:4rem; margin-bottom:20px; opacity:0.3;"></i>
                <p>Database Clinico Pronto</p>
                <p style="font-size:0.8rem; opacity:0.7">Per AI Custom usa il tasto Chiave in alto</p>
            </div>
        </div>

    </div>

    <!-- === LIBRARY MODAL === -->
    <div id="modal-library" class="modal-fs">
        <div class="modal-header">
            <div>
                <h2><i class="fa-solid fa-book-open"></i> Libreria Locale</h2>
                <div style="font-size:0.8rem; color:#aaa;">Gestione offline con Blob Backup</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary btn-sm" onclick="createEmptySet()"><i class="fa-solid fa-plus"></i> Vuoto</button>
                <button class="btn btn-ghost btn-sm" onclick="exportAllSets()"><i class="fa-solid fa-file-export"></i> Backup</button>
                <button class="btn btn-ghost btn-sm" onclick="document.getElementById('file-upload').click()"><i class="fa-solid fa-file-import"></i> Import</button>
                <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importSets(this)">
                <button class="btn btn-danger btn-sm" onclick="closeLibrary()"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div id="lib-list" class="lib-grid"></div>
        </div>
    </div>

    <!-- === EDITOR MODAL === -->
    <div id="modal-editor" class="modal-fs">
        <div class="modal-header">
            <h2><i class="fa-solid fa-pen-to-square"></i> Modifica Set</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" onclick="saveEditorChanges()"><i class="fa-solid fa-check"></i> Salva</button>
                <button class="btn btn-ghost" onclick="closeEditor()">Annulla</button>
            </div>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:20px; display:flex; gap:10px;">
                <input type="text" id="edit-set-name" placeholder="Nome del Set" style="flex:1;">
            </div>
             <div class="actions-row" style="justify-content: flex-start; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                 <label style="margin-right:10px;">Aggiungi Immagini:</label>
                 <button class="btn btn-ghost btn-sm" onclick="document.getElementById('bulk-upload').click()">
                     <i class="fa-solid fa-images"></i> Seleziona da Disco...
                 </button>
                 <input type="file" id="bulk-upload" class="hidden" multiple accept="image/*" onchange="bulkUploadImages(this)">
            </div>
            <div id="editor-list"></div>
        </div>
    </div>

    <!-- === API SETTINGS MODAL === -->
    <div id="modal-settings" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#1e1e2f; padding:30px; border-radius:20px; width:90%; max-width:400px; border:1px solid var(--glass-border);">
            <h3><i class="fa-solid fa-key"></i> Impostazioni API</h3>
            <p style="color:#aaa; font-size:0.9rem;">
                Inserisci la tua API Key di Google Gemini per poter generare immagini personalizzate (es. "Mostri marini").
                <br>I set prefabbricati funzionano anche senza chiave.
            </p>
            <input type="password" id="api-key" placeholder="Incolla qui (inizia con AIzaSy...)">
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-ghost" onclick="document.getElementById('modal-settings').classList.add('hidden')">Chiudi</button>
                <button class="btn-primary" onclick="saveKey()">Salva Chiave</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. INDEXED DB MANAGER ---
        const DB_NAME = 'StimolatoreLessicaleDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'sets';

        class DB {
            static async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
            static async getAllSets() {
                const db = await DB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            static async saveSet(set) {
                const db = await DB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.put(set);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }
            static async deleteSet(id) {
                const db = await DB.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // --- 1. DATA & STATE (EXPANDED CLINICAL SETS) ---
        const CLINICAL_SETS = {
            "anim_liv1": [
                {l:"Cane", p:"Cute dog puppy"}, {l:"Gatto", p:"Cute cat kitten"}, {l:"Topo", p:"Cute mouse"}, 
                {l:"Rana", p:"Green frog"}, {l:"Toro", p:"Bull animal"}, {l:"Mucca", p:"Cow farm animal"}, 
                {l:"Lupo", p:"Wolf"}, {l:"Gufo", p:"Owl bird"}, {l:"Orso", p:"Bear"}, {l:"Ape", p:"Bee insect"}
            ],
            "anim_liv2": [
                {l:"Pecora", p:"Sheep"}, {l:"Medusa", p:"Jellyfish"}, {l:"Gallina", p:"Hen chicken"}, 
                {l:"Balena", p:"Blue whale"}, {l:"Gorilla", p:"Gorilla ape"}, {l:"Giraffa", p:"Giraffe"}, 
                {l:"Maiale", p:"Piglet"}, {l:"Delfino", p:"Dolphin"}, {l:"Cavallo", p:"Horse"}, {l:"Pinguino", p:"Penguin"}
            ],
            "anim_liv3": [
                {l:"Coccodrillo", p:"Crocodile alligator"}, {l:"Tartaruga", p:"Turtle tortoise"}, 
                {l:"Elefante", p:"Elephant"}, {l:"Rinoceronte", p:"Rhinoceros"}, {l:"Ippopotamo", p:"Hippo"}, 
                {l:"Pipistrello", p:"Bat animal"}, {l:"Serpente", p:"Snake"}, {l:"Zebra", p:"Zebra"},
                {l:"Scoiattolo", p:"Squirrel"}, {l:"Farfalla", p:"Butterfly"}
            ],
            "food_liv1": [
                {l:"Pane", p:"Bread loaf"}, {l:"Mela", p:"Red apple"}, {l:"Pera", p:"Pear fruit"}, 
                {l:"Uva", p:"Purple grapes"}, {l:"Latte", p:"Milk bottle"}, {l:"Uovo", p:"Egg"}, 
                {l:"Riso", p:"Rice bowl"}, {l:"Kiwi", p:"Kiwi fruit"}, {l:"Torta", p:"Cake"}, {l:"Pizza", p:"Pizza slice"}
            ],
            "food_liv2": [
                {l:"Banana", p:"Banana"}, {l:"Carota", p:"Carrot"}, {l:"Patata", p:"Potato"}, 
                {l:"Gelato", p:"Ice cream cone"}, {l:"Limone", p:"Lemon"}, {l:"Fragola", p:"Strawberry"}, 
                {l:"Ciliegia", p:"Cherry"}, {l:"Arancia", p:"Orange fruit"}, {l:"Pomodoro", p:"Tomato"}, {l:"Formaggio", p:"Cheese block"}
            ],
            "home_liv1": [
                {l:"Sole", p:"Sun"}, {l:"Luna", p:"Moon"}, {l:"Casa", p:"House cottage"}, 
                {l:"Letto", p:"Bed furniture"}, {l:"Tubo", p:"Pipe"}, {l:"Muro", p:"Brick wall"}, 
                {l:"Faro", p:"Lighthouse"}, {l:"Mare", p:"Sea ocean"}, {l:"Vaso", p:"Flower vase"}, {l:"Dito", p:"Finger hand"}
            ],
            "home_liv2": [
                {l:"Divano", p:"Sofa couch"}, {l:"Matita", p:"Pencil"}, {l:"Tavolo", p:"Wooden table"}, 
                {l:"Valigia", p:"Suitcase luggage"}, {l:"Bambola", p:"Doll toy"}, {l:"Collana", p:"Necklace"}, 
                {l:"Cuscino", p:"Pillow"}, {l:"Pentola", p:"Cooking pot"}, {l:"Orologio", p:"Wall clock"}, {l:"Telefono", p:"Telephone"}
            ],
            "clothes_liv1": [
                {l:"Scarpa", p:"Shoe sneaker"}, {l:"Maglia", p:"T-shirt"}, {l:"Calza", p:"Sock"}, 
                {l:"Borsa", p:"Handbag"}, {l:"Cappello", p:"Hat cap"}, {l:"Guanto", p:"Glove"}, 
                {l:"Gonna", p:"Skirt"}, {l:"Sciarpa", p:"Scarf"}
            ],
            "verbs_liv1": [
                {l:"Mangiare", p:"Boy eating apple"}, {l:"Bere", p:"Girl drinking water glass"}, 
                {l:"Dormire", p:"Child sleeping in bed"}, {l:"Correre", p:"Boy running fast"}, 
                {l:"Lavare", p:"Washing hands soap"}, {l:"Giocare", p:"Kids playing toys"}, 
                {l:"Leggere", p:"Reading book"}, {l:"Scrivere", p:"Writing with pencil"}
            ]
        };

        let state = {
            apiKey: localStorage.getItem('gemini_key') || '',
            items: [], deck: [], memory: { flipped: [], matched: [], lockBoard: false },
            saved: [], currentTheme: 'theme-misto', editingSetId: null, editingItems: []
        };

        // --- 2. INIT ---
        window.onload = async () => {
            const existing = await DB.getAllSets();
            // Refill clinical sets if missing or incomplete
            for (const key of Object.keys(CLINICAL_SETS)) {
                // We overwrite clinical sets to ensure updates appear
                const items = CLINICAL_SETS[key].map(i => ({ label: i.l, prompt: i.p, url: null, isCustom: false }));
                await DB.saveSet({
                    id: 'clin_' + key, name: key.replace('_', ' ').toUpperCase() + " (Prefabbricato)",
                    items: items, theme: 'theme-misto', date: 'Default', isClinical: true
                });
            }
            
            await reloadLibrary();

            document.getElementById('category-select').addEventListener('change', (e) => {
                document.getElementById('custom-input').classList.toggle('hidden', e.target.value !== 'ai_custom');
            });
        };

        async function reloadLibrary() {
            state.saved = await DB.getAllSets();
            document.getElementById('lib-count').innerText = state.saved.length;
            calculateStorageUsage(state.saved);
        }

        function calculateStorageUsage(sets) {
            let totalBytes = 0;
            sets.forEach(s => totalBytes += JSON.stringify(s).length);
            const mb = (totalBytes / (1024 * 1024)).toFixed(1);
            const fill = Math.min((totalBytes / (500 * 1024 * 1024)) * 100, 100); 
            document.getElementById('storage-fill').style.width = fill + '%';
            document.getElementById('storage-text').innerText = `${mb} MB`;
        }

        // --- 3. FULLSCREEN LOGIC ---
        function toggleFullScreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
            setTimeout(() => {
                const isFs = document.fullscreenElement || document.webkitFullscreenElement;
                const icon = document.getElementById('fs-icon');
                if(icon) icon.className = isFs ? 'fa-solid fa-compress' : 'fa-solid fa-expand';
            }, 200);
        }

        // --- 4. SESSION LOGIC ---
        async function startSession() {
            const catSelect = document.getElementById('category-select').value;
            const style = document.getElementById('style-select').value;
            const mode = document.getElementById('mode-select').value;
            const sizeVal = parseInt(document.getElementById('grid-size').value);
            const count = sizeVal * sizeVal;
            const stage = document.getElementById('game-stage');
            
            if(!catSelect) { alert("Seleziona una categoria o apri la Libreria."); return; }
            stage.innerHTML = `<div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--text-secondary);">
                                <i class="fa-solid fa-spinner spin fa-3x"></i>
                                <p style="margin-top:10px;">Generazione stimoli in corso...</p>
                               </div>`;
            document.getElementById('btn-save').classList.add('hidden');

            try {
                let rawData = [];
                if (catSelect === 'ai_custom') {
                    if (!state.apiKey) throw new Error("Per usare AI Custom serve la Chiave API (tasto chiave in alto).");
                    rawData = await fetchAI(document.getElementById('custom-input').value, (mode === 'tact' ? 8 : count));
                } else {
                    let source = CLINICAL_SETS[catSelect];
                    if (!source) throw new Error("Set non trovato");
                    rawData = expandList(source, (mode === 'tact' ? 8 : count));
                }

                state.items = rawData.map(d => ({
                    label: d.l || d.label, prompt: d.p || d.prompt || d.label,
                    url: generateUrl(d.p || d.prompt || d.label, style), isCustom: false
                }));

                state.currentTheme = 'theme-misto';
                renderGameMode(mode);
                document.getElementById('btn-save').classList.remove('hidden');
            } catch (err) {
                stage.innerHTML = `<div style="color:#ef4444; padding:20px; text-align:center;">${err.message}</div>`;
            }
        }

        function changeMode() { if(state.items.length > 0) renderGameMode(document.getElementById('mode-select').value); }
        function renderGameMode(mode) {
            if (mode === 'tact') renderTact();
            else if (mode === 'ran') renderRan();
            else if (mode === 'tombola') renderTombola();
            else if (mode === 'memory') renderMemory();
        }

        // --- 5. RENDERERS ---
        function getPlaceholderUrl(label) { return `https://placehold.co/400?text=${label}`; }
        function renderTact() {
            const stage = document.getElementById('game-stage');
            const item = state.items[Math.floor(Math.random() * state.items.length)];
            stage.innerHTML = `<div class="tact-stage"><div class="tact-card-lg"><img src="${item.url || getPlaceholderUrl(item.label)}"><div class="tact-title">${item.label}</div><button class="btn btn-ghost" style="margin:20px auto; color:#333; border-color:#ccc;" onclick="renderTact()"><i class="fa-solid fa-shuffle"></i> Prossimo</button></div></div>`;
        }
        function renderRan() {
            const stage = document.getElementById('game-stage');
            const gridSize = Math.sqrt(state.items.length) || 4;
            let html = `<div style="padding:20px; overflow:auto;"><div class="ran-grid-container" style="grid-template-columns:repeat(${gridSize}, 1fr);">`;
            state.items.forEach(item => { html += `<div style="background:#f8fafc; padding:5px; border-radius:8px; border:1px solid #e2e8f0; aspect-ratio:1; display:flex; justify-content:center; align-items:center;"><img src="${item.url || getPlaceholderUrl(item.label)}" style="max-width:100%; max-height:100%; object-fit:contain;"></div>`; });
            html += `</div></div>`; stage.innerHTML = html;
        }
        function renderTombola() {
            const stage = document.getElementById('game-stage');
            state.deck = [...state.items].sort(() => Math.random() - 0.5);
            const gridSize = Math.sqrt(state.items.length) || 4;
            stage.innerHTML = `<div class="tombola-layout"><div class="tombola-deck"><div id="deck-area">${getDeckCardHtml()}</div></div><div class="tombola-board"><div class="ran-grid-container" style="grid-template-columns:repeat(${gridSize}, 1fr);">${state.items.map((item, idx) => `<div class="card-grid" id="slot-${idx}" onclick="handleMatchClick(${idx}, '${item.label}')"><img src="${item.url || getPlaceholderUrl(item.label)}"></div>`).join('')}</div></div></div>`;
        }
        function getDeckCardHtml() {
            if (state.deck.length === 0) return `<div style="text-align:center; color:white; font-size:1.5rem;">ðŸŽ‰<br>Finito!</div>`;
            const current = state.deck[0];
            return `<div class="card" style="width:200px;"><img src="${current.url || getPlaceholderUrl(current.label)}"><div style="font-size:1.5rem;font-weight:bold;color:#333;">${current.label}</div></div>`;
        }
        window.handleMatchClick = (idx, label) => {
            if (state.deck.length === 0) return;
            if (label === state.deck[0].label) {
                document.getElementById(`slot-${idx}`).classList.add('matched');
                state.deck.shift(); document.getElementById('deck-area').innerHTML = getDeckCardHtml();
            }
        };
        function renderMemory() {
            const stage = document.getElementById('game-stage');
            let uniqueItems = state.items.slice(0, 8);
            if(uniqueItems.length < 8) uniqueItems = expandList(uniqueItems, 8); 
            let memoryDeck = [...uniqueItems, ...uniqueItems].sort(() => Math.random() - 0.5);
            state.memory = { flipped: [], matched: [], deck: memoryDeck, lockBoard: false };
            let html = `<div class="memory-grid">`;
            memoryDeck.forEach((item, idx) => {
                html += `<div class="memory-card" id="mem-${idx}" onclick="flipCard(${idx})"><div class="memory-inner"><div class="memory-front"><i class="fa-solid fa-question"></i></div><div class="memory-back"><img src="${item.url || getPlaceholderUrl(item.label)}"></div></div></div>`;
            });
            html += `</div>`; stage.innerHTML = html;
        }
        window.flipCard = (idx) => {
            if (state.memory.lockBoard || state.memory.flipped.includes(idx) || state.memory.matched.includes(idx)) return;
            document.getElementById(`mem-${idx}`).classList.add('flipped');
            state.memory.flipped.push(idx);
            if (state.memory.flipped.length === 2) { state.memory.lockBoard = true; checkForMatch(); }
        };
        function checkForMatch() {
            const [idx1, idx2] = state.memory.flipped;
            const match = state.memory.deck[idx1].label === state.memory.deck[idx2].label;
            setTimeout(() => {
                if (match) {
                    document.getElementById(`mem-${idx1}`).classList.add('matched');
                    document.getElementById(`mem-${idx2}`).classList.add('matched');
                    state.memory.matched.push(idx1, idx2);
                } else {
                    document.getElementById(`mem-${idx1}`).classList.remove('flipped');
                    document.getElementById(`mem-${idx2}`).classList.remove('flipped');
                }
                state.memory.flipped = []; state.memory.lockBoard = false;
            }, 800);
        }

        // --- 6. LIBRARY & EDITOR ---
        function openLibrary() { renderLibList(); document.getElementById('modal-library').classList.add('open'); }
        function closeLibrary() { document.getElementById('modal-library').classList.remove('open'); }
        function renderLibList() {
            const container = document.getElementById('lib-list');
            container.innerHTML = state.saved.map(s => `
                <div class="lib-card ${s.isClinical ? 'clinical' : ''}">
                    <div style="font-weight:bold; font-size:1.1rem;">${s.isClinical ? 'ðŸŒ¿ ' : ''}${s.name}</div>
                    <div style="font-size:0.8rem; color:#aaa;">${s.items.length} items â€¢ ${(JSON.stringify(s).length/1024).toFixed(1)} KB</div>
                    <div style="display:flex; gap:5px; margin-top:auto;">
                        <button class="btn btn-primary" style="flex:1; padding:8px;" onclick="loadSet('${s.id}')">Apri</button>
                        <button class="btn btn-ghost" style="padding:8px;" onclick="editSet('${s.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-ghost" style="padding:8px;" onclick="exportSingleSet('${s.id}')" title="Esporta"><i class="fa-solid fa-file-export"></i></button>
                        <button class="btn btn-danger" style="padding:8px;" onclick="deleteSet('${s.id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        window.createEmptySet = () => {
            const cat = prompt("Categoria? (Animali, Cibi, Casa)");
            if(!cat) return;
            let items = [{label:'Parola 1', prompt:'Object 1', url:null}];
            const newSet = { id: Date.now().toString(), name: "Nuovo Set " + cat, items: items, date: new Date().toLocaleDateString(), isClinical: false };
            DB.saveSet(newSet).then(() => { reloadLibrary(); editSet(newSet.id); });
        };
        function saveSetFromSession() {
            const name = prompt("Nome del Set:");
            if (!name) return;
            const newSet = { id: Date.now().toString(), name: name, items: state.items, theme: state.currentTheme, date: new Date().toLocaleDateString(), isClinical: false };
            DB.saveSet(newSet).then(() => { alert("Salvato in Locale!"); reloadLibrary(); });
        }

        window.editSet = async (id) => {
            const allSets = await DB.getAllSets();
            const set = allSets.find(s => s.id === id);
            if (!set) return;
            state.editingSetId = id; state.editingItems = JSON.parse(JSON.stringify(set.items));
            document.getElementById('edit-set-name').value = set.name;
            renderEditorList(); closeLibrary(); document.getElementById('modal-editor').classList.add('open');
        };
        
        function renderEditorList() {
            const list = document.getElementById('editor-list');
            list.innerHTML = state.editingItems.map((item, idx) => `
                <div class="editor-item">
                    <div class="editor-thumb">
                        <div class="loader-overlay hidden" id="loader-${idx}"><i class="fa-solid fa-spinner spin fa-2x"></i></div>
                        ${item.url ? `<img src="${item.url}" onload="this.style.opacity=1; document.getElementById('loader-${idx}').classList.add('hidden')" style="opacity:0; transition:opacity 0.3s">` : '<i class="fa-solid fa-image"></i>'}
                    </div>
                    <div class="editor-meta">
                        <div style="font-weight:bold;">${item.label}</div>
                        <input type="text" class="prompt-input" value="${item.prompt}" onchange="updatePrompt(${idx}, this.value)">
                    </div>
                    <div style="display:flex;gap:5px;">
                        <button class="btn btn-ghost btn-sm" onclick="regenerateItem(${idx})"><i class="fa-solid fa-arrows-rotate"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('upload-${idx}').click()"><i class="fa-solid fa-folder"></i></button>
                        <input type="file" id="upload-${idx}" class="hidden" accept="image/*" onchange="uploadImage(${idx}, this)">
                        <button class="btn btn-danger btn-sm" onclick="removeEditorItem(${idx})"><i class="fa-solid fa-minus"></i></button>
                    </div>
                </div>
            `).join('');
        }
        window.updatePrompt = (idx, val) => { state.editingItems[idx].prompt = val; };
        window.removeEditorItem = (idx) => { state.editingItems.splice(idx, 1); renderEditorList(); };
        
        window.regenerateItem = (idx) => {
            const item = state.editingItems[idx];
            const currentStyle = document.getElementById('style-select').value;
            
            // Show loader
            const loader = document.getElementById(`loader-${idx}`);
            if(loader) loader.classList.remove('hidden');
            
            // Generate new URL (browser will load async)
            item.url = generateUrl(item.prompt, currentStyle); 
            item.isCustom = false;
            
            // Re-rendering will trigger onload again
            renderEditorList();
        };

        function compressImage(file, quality = 0.6, maxWidth = 800) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        window.uploadImage = async (idx, input) => {
            const file = input.files[0]; if (!file) return;
            state.editingItems[idx].url = await compressImage(file);
            state.editingItems[idx].isCustom = true; renderEditorList();
        };
        window.bulkUploadImages = async (input) => {
             const files = Array.from(input.files);
             for(let file of files) {
                 const name = file.name.split('.')[0];
                 const compressed = await compressImage(file);
                 state.editingItems.push({ label: name, prompt: name, url: compressed, isCustom: true });
             }
             renderEditorList();
        };

        function saveEditorChanges() {
            const newName = document.getElementById('edit-set-name').value;
            DB.getAllSets().then(allSets => {
                const set = allSets.find(s => s.id === state.editingSetId);
                if (set) {
                    set.name = newName; set.items = state.editingItems;
                    if(set.isClinical) { set.isClinical = false; set.name += " (Mod)"; }
                    DB.saveSet(set).then(() => { alert("Salvato Locale!"); closeEditor(); reloadLibrary(); });
                }
            });
        }
        function closeEditor() { document.getElementById('modal-editor').classList.remove('open'); openLibrary(); }
        window.deleteSet = (id) => { if (confirm("Eliminare dal dispositivo?")) DB.deleteSet(id).then(() => reloadLibrary()); };
        window.loadSet = async (id) => {
            const allSets = await DB.getAllSets();
            const set = allSets.find(s => s.id === id);
            state.items = set.items; state.currentTheme = set.theme || 'theme-misto';
            closeLibrary(); renderGameMode(document.getElementById('mode-select').value);
        };

        // --- UTILS & AI ---
        function generateUrl(prompt, style) {
            let styleSuffix = "";
            let s = style === 'mixed' ? ['3d','vector','realistic'][Math.floor(Math.random()*3)] : style;
            if(s === '3d') styleSuffix = "cute 3d clay render, soft lighting, white background";
            else if(s === 'vector') styleSuffix = "flat vector icon, minimalist, white background";
            else if(s === 'realistic') styleSuffix = "high quality photo, studio lighting";
            const p = encodeURIComponent(`${prompt}, ${styleSuffix}`);
            const seed = Math.floor(Math.random() * 999999);
            return `https://image.pollinations.ai/prompt/${p}?nologo=true&seed=${seed}&width=400&height=400`;
        }
        async function fetchAI(prompt, count) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${state.apiKey}`;
            const sys = `Genera un JSON array di ${count} oggetti per logopedia su argomento "${prompt}". Format: [{"l":"ItalianLabel", "p":"EnglishVisualDescription"}]. Usa inglese semplice per descrizione visiva.`;
            const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:sys}]}] }) });
            const data = await res.json();
            const txt = data.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
            return JSON.parse(txt);
        }
        function expandList(list, target) {
            let res = [...list]; while (res.length < target) res = res.concat(list);
            return res.slice(0, target).sort(() => Math.random() - 0.5);
        }

        // --- BLOB EXPORT (CRITICAL FOR IPAD) ---
        window.exportAllSets = async () => {
            const sets = await DB.getAllSets();
            downloadJSON(sets, `Backup_Completo_${new Date().toISOString().slice(0,10)}.json`);
        };
        window.exportSingleSet = async (id) => {
            const allSets = await DB.getAllSets();
            const set = allSets.find(s => s.id === id);
            if(set) downloadJSON([set], `Set_${set.name.replace(/\s/g,'_')}.json`);
        };
        function downloadJSON(data, filename) {
            // Use Blob instead of Data URI to handle large files on iPad
            const jsonStr = JSON.stringify(data);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const dl = document.createElement('a'); 
            dl.href = url; 
            dl.download = filename;
            document.body.appendChild(dl); 
            dl.click(); 
            
            // Cleanup
            setTimeout(() => { document.body.removeChild(dl); URL.revokeObjectURL(url); }, 100);
        }
        window.importSets = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    for (const s of imported) await DB.saveSet(s);
                    reloadLibrary(); alert("Importato dal File!");
                } catch(err){alert("Errore file");}
            };
            reader.readAsText(input.files[0]);
        };
        
        window.openSettings = () => document.getElementById('modal-settings').classList.remove('hidden');
        window.saveKey = () => { state.apiKey = document.getElementById('api-key').value; localStorage.setItem('gemini_key', state.apiKey); document.getElementById('modal-settings').classList.add('hidden'); };

    </script>
</body>
</html>
