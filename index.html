<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Stimolatore Lessicale V16</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e2f">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2MzY2ZjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM4YjVjZjYiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0idXJsKCNnKSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiLz48cGF0aCBkPSJNMzYwIDI1NmMwLTU3LjQtNDYuNi0xMDQtMTA0LTEwNHMtMTA0IDQ2LjYtMTA0IDEwNCA0Ni42IDEwNCAxMDQgMTA0YzEyLjggMCAyNS0yLjMgMzYuNC02LjUgMTAuMyA5LjggMjQuNiAxOC41IDQxLjYgMjIuNSAzLjEgMC43IDYuMi0xLjYgNi4yLTQuOCAwLTIuNy0xLjUtNS4yLTMuOS02LjYtMTEuNC02LjctMTguOC0xNi45LTE4LjgtMTYuOSAzMC42LTIzLjIgNTguOS02MS44IDQyLjUtOTEuN3oiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM2MzY2ZjEiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM4YjVjZjYiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0idXJsKCNnKSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiLz48cGF0aCBkPSJNMzYwIDI1NmMwLTU3LjQtNDYuNi0xMDQtMTA0LTEwNHMtMTA0IDQ2LjYtMTA0IDEwNCA0Ni42IDEwNCAxMDQgMTA0YzEyLjggMCAyNS0yLjMgMzYuNC02LjUgMTAuMyA5LjggMjQuNiAxOC41IDQxLjYgMjIuNSAzLjEgMC43IDYuMi0xLjYgNi4yLTQuOCAwLTIuNy0xLjUtNS4yLTMuOS02LjYtMTEuNC02LjctMTguOC0xNi45LTE4LjgtMTYuOSAzMC42LTIzLjIgNTguOS02MS44IDQyLjUtOTEuN3oiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e1e2f 0%, #2d2b55 100%);
            --glass-bg: rgba(30, 30, 50, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #6366f1;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --radius: 16px;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --theme-color: #6366f1;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Noto Sans', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0; 
            padding: env(safe-area-inset-top) 10px 10px 10px; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        .app-shell {
            width: 100%; max-width: 1200px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 20px;
            position: relative; min-height: 85vh;
        }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
        .badge-pro { background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; vertical-align: middle; }
        
        .btn-icon {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--text-primary); width: 40px; height: 40px; border-radius: 10px;
            cursor: pointer; display: grid; place-items: center; transition: 0.2s; font-size: 1.1rem; position: relative;
        }
        .btn-icon:hover { background: var(--accent-color); border-color: var(--accent-color); }
        .badge-count { 
            position:absolute; top:-5px; right:-5px; background:var(--danger-color); 
            color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; 
        }

        /* STORAGE BAR */
        .storage-bar-container {
            font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px;
            display: none;
        }
        @media (min-width: 600px) { .storage-bar-container { display: flex; } }
        .storage-progress { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .storage-fill { height: 100%; background: var(--success-color); width: 0%; transition: width 0.5s; }

        /* CONTROLS */
        .controls-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .control-group { flex: 1; min-width: 200px; }
        .control-group label {
            display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-secondary);
            margin-bottom: 6px; text-transform: uppercase;
        }
        select, input[type="text"], input[type="password"] {
            width: 100%; padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 10px; color: white; font-size: 0.95rem;
            appearance: none; cursor: pointer;
        }
        select:focus, input:focus { border-color: var(--accent-color); }

        /* ACTIONS */
        .actions-row { display: flex; gap: 10px; justify-content: center; padding: 10px 0; }
        .btn {
            padding: 12px 24px; border-radius: 10px; border: none; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1rem;
            transition: transform 0.1s; color: white;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--accent-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-ghost { background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* STAGE */
        #game-stage {
            flex: 1; min-height: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius);
            position: relative; overflow: hidden;
            border: 2px dashed var(--glass-border);
            display: flex; flex-direction: column;
        }

        /* GRID SYSTEM (Responsive) */
        .grid-adaptive {
            display: grid; gap: 15px; width: 100%; max-width: 900px; margin: 0 auto;
            /* Default fallback */
            grid-template-columns: repeat(4, 1fr); 
        }

        /* GAME UI */
        .tact-stage { display: flex; justify-content: center; align-items: center; flex: 1; padding: 20px; }
        .tact-card-lg { background: white; padding: 20px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .tact-card-lg img { width: 100%; height: 350px; object-fit: contain; }
        .tact-title { font-size: 2.5rem; color: #333; margin-top: 15px; font-weight: 800; text-transform: uppercase; }

        .ran-container { padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .ran-header { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .ran-card { background: white; border-radius: 12px; padding: 5px; display: flex; justify-content: center; align-items: center; aspect-ratio: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; border: 2px solid transparent;}
        .ran-card img { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
        .ran-card:active { transform: scale(0.95); border-color: var(--accent-color); }

        .ran-seq-stage { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }
        .ran-seq-img { height: 50vh; width: auto; max-width: 90%; border-radius: 16px; background: white; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); object-fit: contain; }
        .ran-nav-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .ran-nav-btn:hover { background: var(--accent-color); border-color: var(--accent-color); }
        .ran-controls { display: flex; align-items: center; gap: 30px; margin-top: 20px; }

        .tombola-layout { display: flex; flex: 1; height: 100%; flex-direction: column; }
        @media (min-width: 768px) { .tombola-layout { flex-direction: row; } }
        .tombola-deck { flex: 0 0 280px; background: rgba(0,0,0,0.3); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--glass-border); }
        .tombola-board { flex: 1; padding: 20px; background-color: rgba(0,0,0,0.1); overflow-y: auto; }
        
        .memory-card { aspect-ratio: 1; perspective: 1000px; cursor: pointer; position: relative; }
        .memory-inner { width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .memory-card.flipped .memory-inner { transform: rotateY(180deg); }
        .memory-card.matched { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        .memory-front, .memory-back { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .memory-front { background: var(--theme-color); color: white; font-size: 2rem; transform: rotateY(0deg); z-index: 2; }
        .memory-back { background: white; transform: rotateY(180deg); padding: 5px; z-index: 1; }
        .memory-back img { width: 100%; height: 100%; object-fit: contain; }

        /* MODALS */
        .modal-fs { position: fixed; inset: 0; background: #1e1e2f; z-index: 1000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-fs.open { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding-top: env(safe-area-inset-top); } 
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; padding-bottom: 80px; }

        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .lib-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; transition: 0.2s; display: flex; flex-direction: column; gap: 10px; }
        .lib-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent-color); }
        .lib-card.clinical { border-left: 4px solid var(--success-color); }

        .editor-item { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid transparent; flex-wrap: wrap; }
        .editor-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #333; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .editor-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .editor-meta { flex: 1; min-width: 200px; }
        .prompt-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 5px; font-size: 0.8rem; margin-top: 5px; color: #ccc; }
        
        .loader-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; color: white; z-index: 5; }
        
        /* Fallback Text Badge */
        .fallback-badge { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #eee; color: #333; font-weight: 800; text-align: center; border-radius: 8px; font-size: 1.2rem; padding: 5px; }
    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <div>
                <h1>Stimolatore V16</h1>
                <div class="storage-bar-container">
                    <i class="fa-solid fa-hard-drive"></i>
                    <div class="storage-progress"><div id="storage-fill" class="storage-fill"></div></div>
                    <span id="storage-text">DB</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="btn-icon" onclick="toggleFullScreen()" title="Schermo Intero"><i class="fa-solid fa-expand" id="fs-icon"></i></button>
                <button class="btn-icon" onclick="openLibrary()" title="Libreria Set"><i class="fa-solid fa-book-open"></i><span id="lib-count" class="badge-count">0</span></button>
                <button class="btn-icon" onclick="openSettings()" title="API Key"><i class="fa-solid fa-key"></i></button>
            </div>
        </header>

        <!-- CONTROLLI -->
        <div class="controls-row">
            <div class="control-group">
                <label>ModalitÃ </label>
                <select id="mode-select" onchange="changeMode()">
                    <option value="tact">TACT (Denominazione)</option>
                    <option value="ran">RAN (Denominazione Rapida)</option>
                    <option value="tombola">Tombola (Matching)</option>
                    <option value="memory">Memory (Coppie)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Set Clinico</label>
                <select id="category-select">
                    <option value="" disabled selected>-- Seleziona --</option>
                    <optgroup label=" âœ¨ AI Custom">
                        <option value="ai_custom">Prompt Personale...</option>
                    </optgroup>
                    <optgroup label="ðŸ¶ Animali (20)">
                        <option value="anim_liv1">Liv 1: Bisillabe Piane</option>
                        <option value="anim_liv2">Liv 2: Trisillabe</option>
                        <option value="anim_liv3">Liv 3: Complesse</option>
                    </optgroup>
                    <optgroup label="ðŸŽ Cibi (20)">
                        <option value="food_liv1">Liv 1: Semplici</option>
                        <option value="food_liv2">Liv 2: Medi</option>
                    </optgroup>
                    <optgroup label="ðŸ  Casa (20)">
                        <option value="home_liv1">Liv 1: Alta Frequenza</option>
                        <option value="home_liv2">Liv 2: Media Frequenza</option>
                    </optgroup>
                    <optgroup label="ðŸ‘• Abbigliamento (20)">
                        <option value="clothes_liv1">Vestiario Comune</option>
                    </optgroup>
                    <optgroup label="ðŸƒ Verbi (20)">
                        <option value="verbs_liv1">Azioni Quotidiane</option>
                    </optgroup>
                </select>
                <input type="text" id="custom-input" class="hidden" placeholder="Es. Strumenti musicali..." style="margin-top:5px;">
            </div>

            <div class="control-group">
                <label>N. Stimoli</label>
                <select id="grid-size">
                    <option value="20" selected>Tutto il Set (20)</option>
                    <option value="3">9 (3x3)</option>
                    <option value="4">16 (4x4)</option>
                    <option value="5">25 (5x5)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Stile</label>
                <select id="style-select">
                    <option value="mixed">ðŸ”€ Misto</option>
                    <option value="3d">ðŸ§¸ 3D Clay</option>
                    <option value="vector">ðŸŽ¨ Icone</option>
                    <option value="realistic">ðŸ“· Foto</option>
                </select>
            </div>
        </div>

        <div class="actions-row">
            <button class="btn btn-primary" onclick="startSession()">
                <i class="fa-solid fa-play"></i> Genera
            </button>
            <button class="btn btn-ghost" onclick="openLibrary()">
                <i class="fa-solid fa-folder-open"></i> Libreria
            </button>
            <button id="btn-save" class="btn btn-success hidden" onclick="saveSetFromSession()">
                <i class="fa-solid fa-floppy-disk"></i> Salva
            </button>
        </div>

        <!-- STAGE -->
        <div id="game-stage">
            <div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--text-secondary);">
                <i class="fa-solid fa-layer-group" style="font-size:4rem; margin-bottom:20px; opacity:0.3;"></i>
                <p>Seleziona un set e premi Genera</p>
                <p style="font-size:0.8rem; opacity:0.6; margin-top:5px;">"Tutto il Set" usa tutti i 20 stimoli standard.</p>
            </div>
        </div>

    </div>

    <!-- === LIBRARY MODAL === -->
    <div id="modal-library" class="modal-fs">
        <div class="modal-header">
            <h2>Archivio Locale</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary btn-sm" onclick="createEmptySet()"><i class="fa-solid fa-plus"></i></button>
                <button class="btn btn-ghost btn-sm" onclick="exportAllSets()"><i class="fa-solid fa-file-export"></i></button>
                <button class="btn btn-ghost btn-sm" onclick="document.getElementById('file-upload').click()"><i class="fa-solid fa-file-import"></i></button>
                <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importSets(this)">
                <button class="btn btn-danger btn-sm" onclick="closeLibrary()"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div id="lib-list" class="lib-grid"></div>
        </div>
    </div>

    <!-- === EDITOR MODAL === -->
    <div id="modal-editor" class="modal-fs">
        <div class="modal-header">
            <h2>Modifica</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" onclick="saveEditorChanges()">Salva</button>
                <button class="btn btn-ghost" onclick="closeEditor()">Esci</button>
            </div>
        </div>
        <div class="modal-body">
            <input type="text" id="edit-set-name" placeholder="Nome del Set" style="width:100%; margin-bottom:20px;">
             <div class="actions-row" style="justify-content: flex-start; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                 <button class="btn btn-ghost btn-sm" onclick="document.getElementById('bulk-upload').click()"><i class="fa-solid fa-images"></i> Carica Foto...</button>
                 <input type="file" id="bulk-upload" class="hidden" multiple accept="image/*" onchange="bulkUploadImages(this)">
            </div>
            <div id="editor-list"></div>
        </div>
    </div>

    <!-- === API SETTINGS === -->
    <div id="modal-settings" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#1e1e2f; padding:30px; border-radius:20px; width:90%; max-width:400px; border:1px solid var(--glass-border);">
            <h3><i class="fa-solid fa-key"></i> API Key</h3>
            <p style="color:#aaa; font-size:0.9rem;">Per AI Custom (opzionale).</p>
            <input type="password" id="api-key" placeholder="AIzaSy...">
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-ghost" onclick="document.getElementById('modal-settings').classList.add('hidden')">Chiudi</button>
                <button class="btn-primary" onclick="saveKey()">Salva</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. DB MANAGER ---
        const DB_NAME = 'StimolatoreLessicaleDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'sets';
        class DB {
            static async open() { return new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' }); }; r.onsuccess = e => res(e.target.result); r.onerror = e => rej(e.target.error); }); }
            static async getAllSets() { const db = await DB.open(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readonly'); const r = tx.objectStore(STORE_NAME).getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
            static async saveSet(set) { const db = await DB.open(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const r = tx.objectStore(STORE_NAME).put(set); r.onsuccess = () => res(true); r.onerror = () => rej(r.error); }); }
            static async deleteSet(id) { const db = await DB.open(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const r = tx.objectStore(STORE_NAME).delete(id); r.onsuccess = () => res(true); r.onerror = () => rej(r.error); }); }
        }

        // --- 1. DATA (20 ITEMS PER SET) ---
        const CLINICAL_SETS = {
            "anim_liv1": [
                {l:"Cane", p:"Cute dog"}, {l:"Gatto", p:"Cute cat"}, {l:"Topo", p:"Cute mouse"}, {l:"Rana", p:"Green frog"}, {l:"Toro", p:"Bull"}, 
                {l:"Mucca", p:"Cow"}, {l:"Lupo", p:"Wolf"}, {l:"Gufo", p:"Owl"}, {l:"Orso", p:"Bear"}, {l:"Ape", p:"Bee"},
                {l:"Gallo", p:"Rooster"}, {l:"Pollo", p:"Chicken"}, {l:"Oca", p:"Goose"}, {l:"Mulo", p:"Donkey"}, {l:"Falco", p:"Falcon"}, 
                {l:"Ragno", p:"Spider"}, {l:"Bruco", p:"Caterpillar"}, {l:"Verme", p:"Worm"}, {l:"Mosca", p:"Fly"}, {l:"Puma", p:"Puma"}
            ],
            "anim_liv2": [
                {l:"Pecora", p:"Sheep"}, {l:"Medusa", p:"Jellyfish"}, {l:"Gallina", p:"Hen"}, {l:"Balena", p:"Whale"}, {l:"Gorilla", p:"Gorilla"}, 
                {l:"Giraffa", p:"Giraffe"}, {l:"Maiale", p:"Pig"}, {l:"Delfino", p:"Dolphin"}, {l:"Cavallo", p:"Horse"}, {l:"Pinguino", p:"Penguin"},
                {l:"Cammello", p:"Camel"}, {l:"Pantera", p:"Panther"}, {l:"Castoro", p:"Beaver"}, {l:"Coniglio", p:"Rabbit"}, {l:"Formica", p:"Ant"}, 
                {l:"Lumaca", p:"Snail"}, {l:"Gazzella", p:"Gazelle"}, {l:"Bisonte", p:"Bison"}, {l:"Canguro", p:"Kangaroo"}, {l:"Koala", p:"Koala"}
            ],
            "anim_liv3": [
                {l:"Coccodrillo", p:"Crocodile"}, {l:"Tartaruga", p:"Turtle"}, {l:"Elefante", p:"Elephant"}, {l:"Rinoceronte", p:"Rhino"}, {l:"Ippopotamo", p:"Hippo"}, 
                {l:"Pipistrello", p:"Bat"}, {l:"Serpente", p:"Snake"}, {l:"Zebra", p:"Zebra"}, {l:"Scoiattolo", p:"Squirrel"}, {l:"Farfalla", p:"Butterfly"}, 
                {l:"Coccinella", p:"Ladybug"}, {l:"Cavalletta", p:"Grasshopper"}, {l:"Scorpione", p:"Scorpion"}, {l:"Dromedario", p:"Dromedary"}, {l:"Pappagallo", p:"Parrot"}, 
                {l:"Fenicottero", p:"Flamingo"}, {l:"Formichiere", p:"Anteater"}, {l:"Armadillo", p:"Armadillo"}, {l:"Camaleonte", p:"Chameleon"}, {l:"Salamandra", p:"Salamander"}
            ],
            "food_liv1": [
                {l:"Pane", p:"Bread"}, {l:"Mela", p:"Apple"}, {l:"Pera", p:"Pear"}, {l:"Uva", p:"Grapes"}, {l:"Latte", p:"Milk"}, 
                {l:"Uovo", p:"Egg"}, {l:"Riso", p:"Rice"}, {l:"Kiwi", p:"Kiwi"}, {l:"Torta", p:"Cake"}, {l:"Pizza", p:"Pizza"},
                {l:"Noce", p:"Walnut"}, {l:"Fico", p:"Fig"}, {l:"Mais", p:"Corn"}, {l:"Sale", p:"Salt"}, {l:"Pepe", p:"Pepper"}, 
                {l:"Sugo", p:"Tomato sauce"}, {l:"Pasta", p:"Pasta"}, {l:"Kebab", p:"Kebab"}, {l:"Sushi", p:"Sushi"}, {l:"TÃ¨", p:"Tea"}
            ],
            "food_liv2": [
                {l:"Banana", p:"Banana"}, {l:"Carota", p:"Carrot"}, {l:"Patata", p:"Potato"}, {l:"Gelato", p:"Ice cream"}, {l:"Limone", p:"Lemon"}, 
                {l:"Fragola", p:"Strawberry"}, {l:"Ciliegia", p:"Cherry"}, {l:"Arancia", p:"Orange"}, {l:"Pomodoro", p:"Tomato"}, {l:"Formaggio", p:"Cheese"},
                {l:"Biscotto", p:"Cookie"}, {l:"Caramella", p:"Candy"}, {l:"Cioccolato", p:"Chocolate"}, {l:"Insalata", p:"Salad"}, {l:"Panino", p:"Sandwich"}, 
                {l:"Salsiccia", p:"Sausage"}, {l:"Wurstel", p:"Hot dog"}, {l:"Ananas", p:"Pineapple"}, {l:"Anguria", p:"Watermelon"}, {l:"Zucchina", p:"Zucchini"}
            ],
            "home_liv1": [
                {l:"Sole", p:"Sun"}, {l:"Luna", p:"Moon"}, {l:"Casa", p:"House"}, {l:"Letto", p:"Bed"}, {l:"Tubo", p:"Pipe"}, 
                {l:"Muro", p:"Wall"}, {l:"Faro", p:"Lighthouse"}, {l:"Mare", p:"Sea"}, {l:"Vaso", p:"Vase"}, {l:"Dito", p:"Finger"},
                {l:"Naso", p:"Nose"}, {l:"Mano", p:"Hand"}, {l:"Piede", p:"Foot"}, {l:"Buca", p:"Hole"}, {l:"Ramo", p:"Branch"}, 
                {l:"Fiore", p:"Flower"}, {l:"Erba", p:"Grass"}, {l:"Fuoco", p:"Fire"}, {l:"Neve", p:"Snow"}, {l:"Nube", p:"Cloud"}
            ],
            "home_liv2": [
                {l:"Divano", p:"Sofa"}, {l:"Matita", p:"Pencil"}, {l:"Tavolo", p:"Table"}, {l:"Valigia", p:"Suitcase"}, {l:"Bambola", p:"Doll"}, 
                {l:"Collana", p:"Necklace"}, {l:"Cuscino", p:"Pillow"}, {l:"Pentola", p:"Pot"}, {l:"Orologio", p:"Clock"}, {l:"Telefono", p:"Telephone"},
                {l:"Forchetta", p:"Fork"}, {l:"Cucchiaio", p:"Spoon"}, {l:"Coltello", p:"Knife"}, {l:"Bicchiere", p:"Glass"}, {l:"Bottiglia", p:"Bottle"}, 
                {l:"Tovaglia", p:"Tablecloth"}, {l:"Poltrona", p:"Armchair"}, {l:"Tappeto", p:"Rug"}, {l:"Finestra", p:"Window"}, {l:"Specchio", p:"Mirror"}
            ],
            "clothes_liv1": [
                {l:"Scarpa", p:"Shoe"}, {l:"Maglia", p:"T-shirt"}, {l:"Calza", p:"Sock"}, {l:"Borsa", p:"Bag"}, {l:"Cappello", p:"Hat"}, 
                {l:"Guanto", p:"Glove"}, {l:"Gonna", p:"Skirt"}, {l:"Sciarpa", p:"Scarf"}, {l:"Cintura", p:"Belt"}, {l:"Giacca", p:"Jacket"},
                {l:"Pantaloni", p:"Pants"}, {l:"Camicia", p:"Shirt"}, {l:"Cravatta", p:"Tie"}, {l:"Vestito", p:"Dress"}, {l:"Occhiali", p:"Glasses"}, 
                {l:"Anello", p:"Ring"}, {l:"Orecchini", p:"Earrings"}, {l:"Bracciale", p:"Bracelet"}, {l:"Stivale", p:"Boot"}, {l:"Ciabatta", p:"Slipper"}
            ],
            "verbs_liv1": [
                {l:"Mangiare", p:"Eating"}, {l:"Bere", p:"Drinking"}, {l:"Dormire", p:"Sleeping"}, {l:"Correre", p:"Running"}, {l:"Lavare", p:"Washing"}, 
                {l:"Giocare", p:"Playing"}, {l:"Leggere", p:"Reading"}, {l:"Scrivere", p:"Writing"}, {l:"Saltare", p:"Jumping"}, {l:"Ridere", p:"Laughing"}, 
                {l:"Piangere", p:"Crying"}, {l:"Nuotare", p:"Swimming"}, {l:"Volare", p:"Flying"}, {l:"Cadere", p:"Falling"}, {l:"Aprire", p:"Opening"}, 
                {l:"Chiudere", p:"Closing"}, {l:"Tagliare", p:"Cutting"}, {l:"Disegnare", p:"Drawing"}, {l:"Cantare", p:"Singing"}, {l:"Ballare", p:"Dancing"}
            ]
        };

        let state = {
            apiKey: localStorage.getItem('gemini_key') || '',
            items: [], deck: [], memory: { flipped: [], matched: [], lockBoard: false },
            saved: [], currentTheme: 'theme-misto', editingSetId: null, editingItems: [],
            ranMode: 'grid', ranIndex: 0
        };

        // --- 2. INIT ---
        window.onload = async () => {
            const existing = await DB.getAllSets();
            if (existing.length === 0) {
                for (const key of Object.keys(CLINICAL_SETS)) {
                    const items = CLINICAL_SETS[key].map(i => ({ label: i.l, prompt: i.p, url: null, isCustom: false }));
                    await DB.saveSet({ id: 'clin_' + key, name: key.replace('_', ' ').toUpperCase() + " (20)", items: items, theme: 'theme-misto', date: 'Default', isClinical: true });
                }
            }
            await reloadLibrary();
            document.getElementById('category-select').addEventListener('change', (e) => { document.getElementById('custom-input').classList.toggle('hidden', e.target.value !== 'ai_custom'); });
            document.addEventListener('keydown', (e) => { if (state.ranMode === 'single') { if (e.key === 'ArrowRight') nextRan(); if (e.key === 'ArrowLeft') prevRan(); } });
        };

        async function reloadLibrary() {
            state.saved = await DB.getAllSets();
            document.getElementById('lib-count').innerText = state.saved.length;
            let totalBytes = 0; state.saved.forEach(s => totalBytes += JSON.stringify(s).length);
            const mb = (totalBytes / (1024 * 1024)).toFixed(1);
            document.getElementById('storage-fill').style.width = Math.min((totalBytes/(500*1024*1024))*100, 100) + '%';
            document.getElementById('storage-text').innerText = `${mb} MB`;
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();
            setTimeout(() => { document.getElementById('fs-icon').className = document.fullscreenElement ? 'fa-solid fa-compress' : 'fa-solid fa-expand'; }, 200);
        }

        // --- 3. SESSION LOGIC ---
        async function startSession() {
            const catSelect = document.getElementById('category-select').value;
            const style = document.getElementById('style-select').value;
            const mode = document.getElementById('mode-select').value;
            const gridSizeInput = document.getElementById('grid-size').value;
            const stage = document.getElementById('game-stage');
            
            if(!catSelect) { alert("Seleziona una categoria."); return; }
            stage.innerHTML = `<div style="position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--text-secondary);"><i class="fa-solid fa-spinner spin fa-3x"></i><p>Generazione...</p></div>`;
            document.getElementById('btn-save').classList.add('hidden');

            try {
                let rawData = [];
                // Determine COUNT based on user selection
                let targetCount = gridSizeInput === '20' ? 20 : (parseInt(gridSizeInput) ** 2);

                if (catSelect === 'ai_custom') {
                    if (!state.apiKey) throw new Error("Serve API Key.");
                    rawData = await fetchAI(document.getElementById('custom-input').value, targetCount);
                } else {
                    let source = CLINICAL_SETS[catSelect];
                    if (!source) throw new Error("Set non trovato");
                    
                    if (targetCount === 20) {
                        rawData = [...source]; // Use Exact Clinical Set
                    } else {
                        rawData = expandList(source, targetCount); // Expand or Slice
                    }
                }

                state.items = rawData.map(d => ({
                    label: d.l || d.label, prompt: d.p || d.prompt || d.label,
                    url: generateUrl(d.p || d.prompt || d.label, style), isCustom: false
                }));

                state.currentTheme = 'theme-misto';
                renderGameMode(mode);
                document.getElementById('btn-save').classList.remove('hidden');
            } catch (err) {
                stage.innerHTML = `<div style="color:#ef4444; padding:20px; text-align:center;">${err.message}</div>`;
            }
        }

        function changeMode() { if(state.items.length > 0) renderGameMode(document.getElementById('mode-select').value); }
        function renderGameMode(mode) {
            if (mode === 'tact') renderTact();
            else if (mode === 'ran') renderRan();
            else if (mode === 'tombola') renderTombola();
            else if (mode === 'memory') renderMemory();
        }

        // --- 4. RENDERERS ---
        function getPlaceholderUrl(label) { return `https://placehold.co/400?text=${encodeURIComponent(label)}`; }
        function handleImgError(img, label) { img.onerror = null; img.src = getPlaceholderUrl(label); img.style.opacity = 1; }

        function renderTact() {
            const item = state.items[Math.floor(Math.random() * state.items.length)];
            document.getElementById('game-stage').innerHTML = `
                <div class="tact-stage"><div class="tact-card-lg">
                    <img src="${item.url || getPlaceholderUrl(item.label)}" onload="this.style.opacity=1" onerror="handleImgError(this, '${item.label}')" style="opacity:0; transition:opacity 0.3s">
                    <div class="tact-title">${item.label}</div>
                    <button class="btn btn-ghost" style="margin:20px;" onclick="renderTact()"><i class="fa-solid fa-shuffle"></i> Prossimo</button>
                </div></div>`;
        }

        function renderRan() {
            const stage = document.getElementById('game-stage');
            stage.innerHTML = `
                <div class="ran-container">
                    <div class="ran-header">
                        <button class="btn btn-sm ${state.ranMode==='grid'?'btn-primary':'btn-ghost'}" onclick="setRanMode('grid')"><i class="fa-solid fa-table-cells"></i> Griglia</button>
                        <button class="btn btn-sm ${state.ranMode==='single'?'btn-primary':'btn-ghost'}" onclick="setRanMode('single')"><i class="fa-solid fa-image"></i> Sequenza</button>
                    </div>
                    <div id="ran-content" style="flex:1; overflow:auto;"></div>
                </div>`;
            updateRanContent();
        }
        function setRanMode(mode) { state.ranMode = mode; updateRanContent(); }
        function updateRanContent() {
            const container = document.getElementById('ran-content');
            if (state.ranMode === 'grid') {
                // Adaptive Grid for 20 items (5x4)
                const count = state.items.length;
                let cols = 4;
                if(count === 20) cols = 5;
                else if(count === 25) cols = 5;
                else if(count === 9) cols = 3;
                else cols = Math.ceil(Math.sqrt(count));

                let html = `<div class="grid-adaptive" style="grid-template-columns: repeat(${cols}, 1fr);">`;
                state.items.forEach(item => {
                    html += `<div class="ran-card"><img src="${item.url || getPlaceholderUrl(item.label)}" onerror="handleImgError(this, '${item.label}')"></div>`;
                });
                html += `</div>`; container.innerHTML = html;
            } else {
                const item = state.items[state.ranIndex];
                container.innerHTML = `
                    <div class="ran-seq-stage">
                        <img src="${item.url || getPlaceholderUrl(item.label)}" class="ran-seq-img" onerror="handleImgError(this, '${item.label}')">
                        <div style="font-size:2rem; font-weight:bold; margin-top:20px;">${item.label}</div>
                        <div class="ran-controls">
                            <button class="ran-nav-btn" onclick="prevRan()"><i class="fa-solid fa-arrow-left"></i></button>
                            <span style="font-size:1.2rem; opacity:0.7;">${state.ranIndex + 1} / ${state.items.length}</span>
                            <button class="ran-nav-btn" onclick="nextRan()"><i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    </div>`;
            }
        }
        function nextRan() { if (state.ranIndex < state.items.length - 1) { state.ranIndex++; updateRanContent(); } }
        function prevRan() { if (state.ranIndex > 0) { state.ranIndex--; updateRanContent(); } }

        function renderTombola() {
            state.deck = [...state.items].sort(() => Math.random() - 0.5);
            // Adaptive Grid
            const count = state.items.length;
            let cols = count === 20 ? 5 : Math.ceil(Math.sqrt(count));
            
            document.getElementById('game-stage').innerHTML = `<div class="tombola-layout"><div class="tombola-deck"><div id="deck-area">${getDeckCardHtml()}</div></div><div class="tombola-board"><div class="grid-adaptive" style="grid-template-columns:repeat(${cols}, 1fr);">${state.items.map((item, idx) => `<div class="card-grid" id="slot-${idx}" onclick="handleMatchClick(${idx}, '${item.label}')"><img src="${item.url || getPlaceholderUrl(item.label)}" onerror="handleImgError(this, '${item.label}')"></div>`).join('')}</div></div></div>`;
        }
        function getDeckCardHtml() {
            if (state.deck.length === 0) return `<div style="text-align:center; color:white; font-size:1.5rem;">ðŸŽ‰<br>Finito!</div>`;
            const current = state.deck[0];
            return `<div class="card" style="width:200px;"><img src="${current.url || getPlaceholderUrl(current.label)}" onerror="handleImgError(this, '${current.label}')"><div style="font-size:1.5rem;font-weight:bold;color:#333;">${current.label}</div></div>`;
        }
        window.handleMatchClick = (idx, label) => {
            if (state.deck.length === 0 || label !== state.deck[0].label) return;
            document.getElementById(`slot-${idx}`).classList.add('matched');
            state.deck.shift(); document.getElementById('deck-area').innerHTML = getDeckCardHtml();
        };

        function renderMemory() {
            // Memory Logic: Use max 10 pairs (20 cards) if using Full Set to fit screen
            let useItems = state.items;
            if(useItems.length > 10) useItems = useItems.slice(0, 10); // Cap at 10 pairs for playability
            else if(useItems.length < 8) useItems = expandList(useItems, 8); 

            let memoryDeck = [...useItems, ...useItems].sort(() => Math.random() - 0.5);
            state.memory = { flipped: [], matched: [], deck: memoryDeck, lockBoard: false };
            
            // Grid: 20 cards = 5x4. 
            let cols = 5;
            if (memoryDeck.length === 16) cols = 4;
            
            let html = `<div class="memory-grid" style="grid-template-columns: repeat(${cols}, 1fr);">`;
            memoryDeck.forEach((item, idx) => {
                html += `<div class="memory-card" id="mem-${idx}" onclick="flipCard(${idx})"><div class="memory-inner"><div class="memory-front"><i class="fa-solid fa-question"></i></div><div class="memory-back"><img src="${item.url || getPlaceholderUrl(item.label)}" onerror="handleImgError(this, '${item.label}')"></div></div></div>`;
            });
            html += `</div>`; document.getElementById('game-stage').innerHTML = html;
        }
        window.flipCard = (idx) => {
            if (state.memory.lockBoard || state.memory.flipped.includes(idx) || state.memory.matched.includes(idx)) return;
            document.getElementById(`mem-${idx}`).classList.add('flipped');
            state.memory.flipped.push(idx);
            if (state.memory.flipped.length === 2) { state.memory.lockBoard = true; setTimeout(checkForMatch, 800); }
        };
        function checkForMatch() {
            const [idx1, idx2] = state.memory.flipped;
            if (state.memory.deck[idx1].label === state.memory.deck[idx2].label) {
                document.getElementById(`mem-${idx1}`).classList.add('matched');
                document.getElementById(`mem-${idx2}`).classList.add('matched');
                state.memory.matched.push(idx1, idx2);
            } else {
                document.getElementById(`mem-${idx1}`).classList.remove('flipped');
                document.getElementById(`mem-${idx2}`).classList.remove('flipped');
            }
            state.memory.flipped = []; state.memory.lockBoard = false;
        }

        // --- 6. COMMON UTILS ---
        function generateUrl(prompt, style) {
            let s = style === 'mixed' ? ['3d','vector','realistic'][Math.floor(Math.random()*3)] : style;
            let suffix = s==='3d' ? "cute 3d clay" : s==='vector' ? "flat vector icon" : "photo";
            const seed = Math.floor(Math.random() * 999999);
            return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}, ${suffix}, white background?nologo=true&seed=${seed}&width=400&height=400`;
        }
        async function fetchAI(prompt, count) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify({ contents:[{parts:[{text:`Genera un JSON array di ${count} oggetti: [{"l":"IT","p":"EN"}]. Topic: ${prompt}`}]}] }) 
            });
            const d = await res.json();
            return JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim());
        }
        function expandList(list, target) {
            let res = [...list]; while (res.length < target) res = res.concat(list);
            return res.slice(0, target).sort(() => Math.random() - 0.5);
        }

        // --- LIBRARY & EDITOR (SAME AS V15) ---
        function openLibrary() { renderLibList(); document.getElementById('modal-library').classList.add('open'); }
        function closeLibrary() { document.getElementById('modal-library').classList.remove('open'); }
        function renderLibList() {
            const container = document.getElementById('lib-list');
            container.innerHTML = state.saved.map(s => `
                <div class="lib-card ${s.isClinical ? 'clinical' : ''}">
                    <div style="font-weight:bold; font-size:1.1rem;">${s.isClinical ? 'ðŸŒ¿ ' : ''}${s.name}</div>
                    <div style="font-size:0.8rem; color:#aaa;">${s.items.length} items â€¢ ${(JSON.stringify(s).length/1024).toFixed(1)} KB</div>
                    <div style="display:flex; gap:5px; margin-top:auto;">
                        <button class="btn btn-primary" style="flex:1; padding:8px;" onclick="loadSet('${s.id}')">Apri</button>
                        <button class="btn btn-ghost" style="padding:8px;" onclick="editSet('${s.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-ghost" style="padding:8px;" onclick="exportSingleSet('${s.id}')" title="Esporta"><i class="fa-solid fa-file-export"></i></button>
                        <button class="btn btn-danger" style="padding:8px;" onclick="deleteSet('${s.id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }
        window.createEmptySet = () => {
            const cat = prompt("Categoria?"); if(!cat) return;
            let items = [{label:'Oggetto 1', prompt:'Object 1', url:null}];
            const newSet = { id: Date.now().toString(), name: "Nuovo " + cat, items: items, date: new Date().toLocaleDateString(), isClinical: false };
            DB.saveSet(newSet).then(() => { reloadLibrary(); editSet(newSet.id); });
        };
        function saveSetFromSession() {
            const name = prompt("Nome del Set:"); if (!name) return;
            const newSet = { id: Date.now().toString(), name: name, items: state.items, theme: state.currentTheme, date: new Date().toLocaleDateString(), isClinical: false };
            DB.saveSet(newSet).then(() => { alert("Salvato!"); reloadLibrary(); });
        }
        window.editSet = async (id) => {
            const allSets = await DB.getAllSets(); const set = allSets.find(s => s.id === id); if (!set) return;
            state.editingSetId = id; state.editingItems = JSON.parse(JSON.stringify(set.items));
            document.getElementById('edit-set-name').value = set.name; renderEditorList(); closeLibrary(); document.getElementById('modal-editor').classList.add('open');
        };
        function renderEditorList() {
            document.getElementById('editor-list').innerHTML = state.editingItems.map((item, idx) => `
                <div class="editor-item">
                    <div class="editor-thumb">
                        <div class="loader-overlay hidden" id="loader-${idx}"><i class="fa-solid fa-spinner spin"></i></div>
                        ${item.url ? `<img src="${item.url}" onload="this.style.opacity=1; document.getElementById('loader-${idx}').classList.add('hidden')" onerror="handleImgError(this, '${item.label}'); document.getElementById('loader-${idx}').classList.add('hidden')" style="opacity:0; transition:opacity 0.3s">` : '<div class="fallback-badge">'+item.label+'</div>'}
                    </div>
                    <div class="editor-meta">
                        <div style="font-weight:bold;">${item.label}</div>
                        <input type="text" class="prompt-input" value="${item.prompt}" onchange="updatePrompt(${idx}, this.value)">
                    </div>
                    <div style="display:flex;gap:5px;">
                        <button class="btn btn-ghost btn-sm" onclick="regenerateItem(${idx})"><i class="fa-solid fa-arrows-rotate"></i></button>
                        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('upload-${idx}').click()"><i class="fa-solid fa-folder"></i></button>
                        <input type="file" id="upload-${idx}" class="hidden" accept="image/*" onchange="uploadImage(${idx}, this)">
                        <button class="btn btn-danger btn-sm" onclick="removeEditorItem(${idx})"><i class="fa-solid fa-minus"></i></button>
                    </div>
                </div>`).join('');
        }
        window.updatePrompt = (idx, val) => { state.editingItems[idx].prompt = val; };
        window.removeEditorItem = (idx) => { state.editingItems.splice(idx, 1); renderEditorList(); };
        window.regenerateItem = (idx) => {
            document.getElementById(`loader-${idx}`).classList.remove('hidden');
            setTimeout(() => {
                state.editingItems[idx].url = generateUrl(state.editingItems[idx].prompt, document.getElementById('style-select').value);
                state.editingItems[idx].isCustom = false; renderEditorList();
            }, 500); // Stagger
        };
        function compressImage(file) { return new Promise((res) => { const r = new FileReader(); r.onload = e => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); let w=i.width, h=i.height; if(w>800){h*=800/w;w=800;} c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); res(c.toDataURL('image/jpeg', 0.6)); }; i.src = e.target.result; }; r.readAsDataURL(file); }); }
        window.uploadImage = async (idx, input) => { const f = input.files[0]; if(!f) return; state.editingItems[idx].url = await compressImage(f); state.editingItems[idx].isCustom = true; renderEditorList(); };
        window.bulkUploadImages = async (input) => { for(let f of input.files) { state.editingItems.push({ label: f.name.split('.')[0], prompt: f.name.split('.')[0], url: await compressImage(f), isCustom: true }); } renderEditorList(); };
        function saveEditorChanges() {
            const newName = document.getElementById('edit-set-name').value;
            DB.getAllSets().then(all => { const s = all.find(x => x.id === state.editingSetId); if(s) { s.name = newName; s.items = state.editingItems; if(s.isClinical){s.isClinical=false; s.name+=" (Mod)";} DB.saveSet(s).then(() => { alert("Salvato!"); closeEditor(); reloadLibrary(); }); } });
        }
        function closeEditor() { document.getElementById('modal-editor').classList.remove('open'); openLibrary(); }
        window.deleteSet = (id) => { if(confirm("Eliminare?")) DB.deleteSet(id).then(() => reloadLibrary()); };
        window.loadSet = async (id) => { const all = await DB.getAllSets(); const s = all.find(x => x.id === id); state.items = s.items; closeLibrary(); renderGameMode(document.getElementById('mode-select').value); };
        window.exportAllSets = async () => { const s = await DB.getAllSets(); downloadJSON(s, `Backup_Full.json`); };
        window.exportSingleSet = async (id) => { const all = await DB.getAllSets(); const s = all.find(x => x.id === id); if(s) downloadJSON([s], `Set_${s.name}.json`); };
        function downloadJSON(d, n) { const b = new Blob([JSON.stringify(d)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=n; document.body.appendChild(a); a.click(); setTimeout(()=>URL.revokeObjectURL(u),100); }
        window.importSets = (input) => { const r = new FileReader(); r.onload = async e => { try { const d = JSON.parse(e.target.result); for(const s of d) await DB.saveSet(s); reloadLibrary(); alert("Importato!"); } catch(err){alert("Errore");} }; r.readAsText(input.files[0]); };
        window.openSettings = () => document.getElementById('modal-settings').classList.remove('hidden');
        window.saveKey = () => { state.apiKey = document.getElementById('api-key').value; localStorage.setItem('gemini_key', state.apiKey); document.getElementById('modal-settings').classList.add('hidden'); };

    </script>
</body>
</html>
